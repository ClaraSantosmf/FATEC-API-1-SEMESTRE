<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, inicial-scale-1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css">
  <link rel="stylesheet" href="style/custom.css">
  <link rel="stylesheet" href="./style/editar_grupo.css">
  <title>PBLTex ::. Editar Grupo</title>
</head>
<body onload="preencher_campos_formulário(obter_id()); carregar_lista_aluno_turma(); carregar_lista_aluno_grupo();">
  <header class="header">
    <img src="./imagens/Logo.png" alt="logo">
  </header>

  <div class="flex-container">
    <div class="flex-item-center">
      <div>
        <h1>Formulário de Ediçao de Grupo</h1>
      </div>
    <div name="main">
      <div name="Fgrupo" style="padding-top: 34px;">
        <div>
          <label for="fgrupo"><strong>Nome do Grupo:</strong></label>
          <input type="text" name="fgrupo" id="fgrupo">
        </div>
        <div>
          <label for="fnome"><strong>Nome da Turma:</strong></label>
          <input type="text" name="fnome" id="fnome">
        </div>
        <div>
          <label for="fprofessor"><strong>Professor responsável:</strong></label>
          <input type="text" name="fprofessor" id="fprofessor">
        </div>
        <div>
          <label for="fdata"><strong>Data de Inicio:</strong></label>
          <input type="date" name="fdata" id="fdata">
        </div>
        <div style="padding-top: 21px;">
          <button onclick="requisitar_editar_grupo(obter_id())">Salvar</button>
        </div>
      </div>
    </div>
    </div>
        <div class="flex-item-left">
        <div>
          <label for="alunos"><strong>Alunos da Turma:</strong></label>
          <select name="alunos" id="lista-alunos"></select>
        </div>
         <button onclick="adicionar_aluno_grupo()">Adicionar Aluno</button>
        </div>
        <div class="flex-item-rigth">
        <div>
          <label for="alunos"><strong>Alunos do Grupo:</strong></label>
          <select name="alunos" id="lista-alunos"></select>
        </div>
          <button onclick="remover_aluno_grupo()">Remover Aluno</button>
          </div>
</div>

<script>
  /** Realiza o preenchimento inicial dos campos do formulario
  @param (string) id _ o identificador único do grupo.
*/
  async function preencher_campos_formulario(id){
    const grupo = await obter_grupo(id)
    if(turma){
      document.getElementById('fgrupo')['value'] = grupo["grupo"]
      document.getElementById('fnome')['value'] = turma["nome"]
      document.getElementById('fprofessor')['value'] = turma["professor"]
      document.getElementById('fdata')['value'] = turma["data_de_inicio"]
    }
  }
  /** Realiza a submissão da edição da turma para o backend
   * @param(string) id - o identificador do grupo.
   */
async function requisitar_editar_grupo(id){
  const decisao_usuario = criar_modal_confirmacao_edicao();
  if(decisao_usuario){
    const grupo = {
      "grupo" : document.getElementById('fgrupo')['value'],
      "nome" : document.getElementById('fnome')['value'],
      "professor" : document.getElementById('fprofessor')['value'],
      "data_de_inicio" : document.getElementById('fdata')['value']
    }
    fetch (`substituir por rota${id}/`,{method: "POST", body:JSON.stringify(grupo)})
    .then(() => window.location.href = 'editar_grupo.html?id=' + id)
  }
}
/** Obtém o grupo pelo id
 * *@param (string) id - identificador único do grupo
 * *@returns(object) rertonará undefined ou um objeto
 * */
async function obter_grupo(id) {
  const resposta = await fetch (`substituir por rota${id}`, {method: "POST"})
      const grupo = await resposta.json()
      console.log(grupo)
      return grupo
}
/** Recupera o id do grupo presente como consulta na URL
* @returns (string) id - o identificador único
*/
  function obter_id(){ return new URLSearchParams(window.location.search).get('id') }
        
/** Cria um modal para a confirmação do usuário
* @return (boolean) resposta - decisão do usuário
*/
  function criar_modal_confirmar_edicao(){
  const mensagem = "Atenção! Os dados do grupo serão modificados.\nDeseja prosseguir com a edição?"
  return window.confirm(mensagem);
}
/** Carregar uma lista de alunos da turma que esta sendo editada
 * 
*/
async function carregar_lista_aluno_turma() {
    const turmaId = obter_id_turma();
    const response = await fetch(`colocar rota turma/${turmaId}/alunos`); //criar uma rota para obter alunos d euma turma especifica
    const alunos = await response.json();
    const listaAlunos = document.getElementById(`lista-alunos`);
    
    alunos.array.forEach(aluno => {
      const option = document.createElement(`option`);
      option.value = aluno.id; // Substituir pelo identificador unico do aluno
      option.text = aluno.nome; // caso o aluno tenha um atributo como `nome`
      listaAlunos.appendChild(option);
    });
}
/**Implementando Funcao para obter o id da turma que esta sendo editada
 *  Obtem o ID da turma da URL e retorna
*/
function obter_id_turma() {
  function obter_id_turma() {
    const urlParams = new URLSearchParams(Window.location.search);
    const turmaId = urlParams.get(`id`);
    return turmaId;
  }
}
async function adicionar_aluno_grupo() {
  const alunoId = document.getElementById(`lista-alunos`.value);
  const turmaId = obter_id_turma();
  const response = await fetch(`colocar rota de turmas / ${turmaId}/adicionarAluno?id=${alunoId}`, {method: `POST`});
  const resultado = await response.json();
  console.log(resultado.mensagem);
}
/** Implementando Funcao para obter o id do grupo que esta sendo editada
 * Obtem o ID do grupo na URL e retorna
*/
async function carregar_lista_aluno_grupo(){
  const grupoId = obter_id();
  const response = await fetch(`colocar rota obter alunos do grupo/${grupoId}`);
  const alunos = await response.json();

  const listaAlunos =document.getElementById(`lista-alunos`);
  alunos.forEach(aluno => {
    const option = document.vreateElement(`option`);
    option.value = aluno.id; // Substituir pelo identificador unico do aluno
    option.text = aluno.nome;  // caso o aluno tenha um atributo como `nome`
    listaAlunos.appendChild(option);
  });
}
/**Funcao para excluir um aluno do grupo que esta sendo editado
 * 
*/
async function remover_aluno_grupo () {
  const grupoid = obter_id ();
  const alunoId = document.getElementById(`lista-alunos`).value;

  const response = await fetch (`colocar rota excluir alunos do grupo/${grupoid}/${alunoId}`, {method: `DELETE`});
  const resultado = await response.json();

  // Atualizar a listagem apos a exclusao de alunos
  if(resultado.sucesso) {
    alert(resultado.mensagem);
    const listaAlunos = document.getElementById(`lista-alunos`);
    listaAlunos.innerHTML = ``;
    await carregar_lista_aluno_grupo();
  }
  else{ alert (resultado.mensagem);}
}
</script>
    <div class="muleke">
      <a href="index.html">
      <img src="./imagens/mascote2.png" alt="mascote">
    </a>
    </div>
</body>
</html>