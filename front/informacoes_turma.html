<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciamento de Alunos</title>
     <link rel="stylesheet" href="../front/style/informacoes_turma.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css"
    />
    <link rel="stylesheet" href="style/custom.css" />
  </head>
  <body onload="preencher_info_turma(obter_id())">
    <header class="header">
      <a href="index.html">
        <img src="./imagens/Logo.png" alt="logo" />
      </a>
    </header>_
    <button id="turma" class="menu-button">
      <a href="gerenciamento_turmas.html">Turma</a>
    </button>
    <div class="container-info">
        <div class="info-turma">
          <label for="fnomeTurma">Nome da Turma:</label>
          <input class="fnomeTurma" type="text" id="fnomeTurma" disabled />
          <label for="fnomeProfessor">Nome do Professor:</label>
          <input class="fnomeProfessor" type="text" id="fnomeProfessor" disabled />
          <label for="fnomeProfessor">Quantidade de Alunos:</label>
          <input class="fquantidadeAlunos" type="text" id="fquantidadeAlunos" disabled />
        </div>
        <div class="container-ciclos">
          <p class="titulo-ciclos"><strong>Pesos Ciclos:</strong></p>
          <div class="ciclo-peso"></div>
        </div>
            
        </div>
    </div>
    <div class="aluno-container">
        <p class="aviso_ciclo_aberto">Ciclo aberto para nota: x</p>
        <div class="header-container">
          <div class="header-title titulo_alunos">Nome</div>
          <div class="header-title titulo_notas">Notas</div>
          <div class="header-title titulo_media">Media</div>
        </div>
          <div class="corpo_tabela">
            <!-- Os Alunos serão adicionadas automaticamente aqui -->
          </div>
    </div>
     <!-- Moleke -->
     <div class="muleke">
        <a href="index.html">
          <img src="./imagens/mascote2.png" alt="mascote" />
        </a>
      </div>
      <script>
        async function preencher_info_turma(id){
          const turma = await obter_turma(id)
          const PesoCiclo = await listar_ciclos_turma(id)
          const alunos = await listar_alunos_turma(id)
          const notasAlunos = await listar_notas_alunos(id)
          await exibirAlunos(alunos, notasAlunos)
          console.log(turma["nome"])
          console.log(turma.professor)
          if (turma){
            const nomeTurmaElement = document.querySelector('.fnomeTurma');
            const nomeProfessorElement = document.querySelector('.fnomeProfessor');
            const quantidadeAlunosElement = document.querySelector('.fquantidadeAlunos');
            const cicloPeso = document.querySelector(".ciclo-peso");
            nomeTurmaElement.value = turma["nome"];
            nomeProfessorElement.value = turma["professor"];
            quantidadeAlunosElement.value = alunos ? Object.keys(alunos).length : 0;
            for (let chave in PesoCiclo){
              const pesoData = PesoCiclo[chave];

              const NomeCiclo = document.createElement("span");
              NomeCiclo.className = "ciclo";
              NomeCiclo.innerHTML = `C${pesoData.numero_ciclo}:`;

              const PesoNota = document.createElement("span");
              PesoNota.className = "peso";
              PesoNota.textContent = pesoData.peso_nota;

              cicloPeso.appendChild(NomeCiclo);
              cicloPeso.appendChild(PesoNota);
            }
          }
        }

        function exibirAlunos(alunos, notasAlunos) {
          const container = document.querySelector(".corpo_tabela");

          for (const chave in alunos) {
            if (alunos.hasOwnProperty(chave)) {
              const aluno = alunos[chave];
              const nomeAluno = aluno.nome;
              const alunoId = aluno.RA;

              const alunoSquare = document.createElement("div");
              alunoSquare.className = "aluno-square";
              alunoSquare.id = `${alunoId}`;

              const elementoNomeAluno = document.createElement("p");
              elementoNomeAluno.className = "aluno";
              elementoNomeAluno.textContent = nomeAluno.charAt(0).toUpperCase() + nomeAluno.slice(1);

              alunoSquare.appendChild(elementoNomeAluno);

              const campoNota = document.createElement("div");
              campoNota.className = "campoNota";

              for (const notaChave in notasAlunos) {
                if (notasAlunos.hasOwnProperty(notaChave)) {
                  const notaAluno = notasAlunos[notaChave];
                  const notaAlunoId = notaAluno.id_aluno;
                  const id_ciclo = notaAluno.id_ciclo;
                  const valorNota = notaAluno.valor;

                  if (notaAlunoId == alunoId) {
                    const InputNotas = document.createElement("input");
                    InputNotas.className = "valor";
                    InputNotas.type = "number";
                    InputNotas.value = valorNota;
                    InputNotas.id = id_ciclo;

                    if(valorNota == 0) {
                     InputNotas.value= ""
                    }
                      
                    // Verifique se a nota já foi atribuída para torná-la somente leitura
                    if (CicloAberto(id_ciclo)) {
                      InputNotas.setAttribute("readonly", true);
                    }

                    campoNota.appendChild(InputNotas);
                  }
                }
              }
                alunoSquare.appendChild(campoNota);
                const mediaAluno = document.createElement("div");
                mediaAluno.className = "media";
                mediaAluno.type = "number";
                mediaAluno.innerHTML = "Media"
                alunoSquare.appendChild(mediaAluno)
                container.appendChild(alunoSquare);
            }
          }
        }

        // Função que verifica se o ciclo está aberto
        function CicloAberto(id_ciclo) {
          return true; 
        }

        async function listar_ciclos_turma(id){
          const response = await fetch (`http://localhost:8080/api/v1/ciclos/listar/${id}`, {method: "GET"})
          const PesoCiclo = await response.json()
          console.log(PesoCiclo)
          return PesoCiclo
        }

        async function listar_alunos_turma(id) {
          const response = await fetch (`http://localhost:8080/api/v1/turmas_alunos/listar_alunos_da_turma/${id}`, {method: "GET"})
          const alunos = await response.json()
          console.log(alunos)
          return alunos
        }

        async function listar_notas_alunos(id) {
          const response = await fetch (`http://localhost:8080/api/v1/notas/turma/listar/${id}`, {method: "GET"})
          const notasAlunos = await response.json()
          console.log(notasAlunos)
          return notasAlunos
        }

        async function obter_turma(id) {
            const resposta = await fetch (`http://localhost:8080/api/v1/turmas/listar/${id}`, {method: "GET"})
            const turma = await resposta.json()
            console.log(turma)
            return turma
        }
        function obter_id(){ return new URLSearchParams(window.location.search).get('id')
        //        /** Recupera o id da turma presente como consulta na URL
        //  * @returns {string} id - o identificador único
        }
      </script>
  </body>
</html>